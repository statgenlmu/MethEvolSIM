---
title: "Definition of Archipelagos"
author: "Sara"
date: "`r Sys.Date()`"
output: html_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# If missing, install required packages

if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

if (!requireNamespace("rtracklayer", quietly = TRUE)) {
  BiocManager::install("rtracklayer")
}

if (!requireNamespace("GenomicRanges", quietly = TRUE)) {
  BiocManager::install("GenomicRanges")
}

library(GenomicRanges)
library(rtracklayer)
```


# Archipelago definition

We define archipelagos as genomic regions containing clusters of CGIs. We can interpret archipelagos as regions of the genome larger than CGI that together may regulate a gene or set of genes. Therefore, an approach to define archipelagos can be to choose thresholds that lead to clustering CGI in a way so that each archipelago overlaps with a promoter region (or maximizes cases of overlap single-archipelago and promoter).

Our approach then has the following steps:

1. Definition of promoter regions.
2. Filtering of CGI by promoter overlap.


## Step 1: Definition of promoter regions

As in [@vernaz2022epigenetic], since no functional annotation exists for Lake Malawi cichlid genomes, we define promoter regions in silico as regions Â±1 kbp around the TSS.

For that, we use [Annotation Features File (GTF) from the NCBI RefSeq Assembly](https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000238955.4/)

```{r}
# Load the GTF file
gtf_file <- "/home/sara/methylation/MethEvolSIM/application_examples/abc_inferences/genomic_dist/ncbi_dataset/ncbi_dataset/data/GCF_000238955.4/genomic.gtf" 
gtf <- import(gtf_file)
head(gtf)
```

The gtf file is structured as a GRanges object containing genomic annotation information with the following key components (columns):

- `seqnames`: Chromosome or scaffold name (e.g., NC_036780.1).

- `ranges`: Start and end positions of the genomic feature.

- `strand`: Strand of the feature (+ for forward strand, - for reverse strand).

- `source`: Annotation source (e.g., Gnomon).

- `type`: Feature type (e.g., gene, transcript, exon).

- `Metadata`: Additional columns include gene_id, transcript_id, gene, product, gene_biotype, exon_number, etc., which describe the feature in detail.

Example Entries:

- Row 1: A gene on the + strand, identified as LOC106676409, classified as lncRNA.

- Row 2: A transcript corresponding to the same gene.

- Rows 3-5: Exons belonging to the transcript.

- Row 6: A gene on the - strand, classified as protein_coding.

We filter for transcripts:

```{r}
# Filter for transcripts
gtf_transcripts <- gtf[gtf$type == "transcript", ]
head(gtf_transcripts)
```

And define the TSS by accounting for the strand orientation so that:

- For Features on the + Strand: The TSS is the smallest genomic coordinate (start).

- For Features on the - Strand: The TSS is the largest genomic coordinate (end), as transcription occurs in the reverse direction.

```{r}
# Extract TSS
promoters <- data.frame(
  chr = seqnames(gtf_transcripts),
  tss = ifelse(strand(gtf_transcripts) == "+", start(gtf_transcripts), end(gtf_transcripts)),
  strand = strand(gtf_transcripts)
)
head(promoters)
```

The promoters data frame contains:

- `chr`: Chromosome names

- `tss`: Transcription start sites

- `strand`: Strand orientation of the transcripts

## Step 2: Filtering of CGI by promoter overlap

CGI annotation file (`.txt` file) obtained with makeCGI v1.3.4 [@hiddenMarkov]

```{r}
# Load the CGI annotation file
cgi_file <- "/home/sara/methylation/MethEvolSIM/application_examples/abc_inferences/genomic_dist/CGI-Mzebra.txt" 
cgif <- read.table(cgi_file, header = TRUE, sep = "\t")
head(cgif)
```

Convert the promoter and CGI data to `GRanges` objects for genomic interval operations:

```{r}
# Create GRanges for promoters
promoter_gr <- GRanges(
  seqnames = promoters$chr,
  ranges = IRanges(start = promoters$tss, end = promoters$tss),
  strand = promoters$strand
)

# Create GRanges for CGI
cgi_gr <- GRanges(
  seqnames = cgif$chr,
  ranges = IRanges(start = cgif$start, end = cgif$end)
)
```

Use `findOverlaps` to find promoters within or near CpG islands:

```{r}
# Find overlaps
overlaps <- findOverlaps(promoter_gr, cgi_gr)

# Extract overlapping promoter indices
promoters_with_cgi <- promoters[queryHits(overlaps), ]
cgi_overlaps <- cgif[subjectHits(overlaps), ]

# Combine data for output
promoter_cgi_overlap <- cbind(promoters_with_cgi, cgi_overlaps)
head(promoter_cgi_overlap)
```

The `promoter_cgi_overlap` dataset combines information about promoters and CpG islands (CGIs) where they overlap. It contains the following columns:

- `chr`: The chromosome where the promoter is located.
    
- `tss`: The transcription start site (TSS) position of the promoter.

- `strand`: The strand of the promoter (+ or -).

- `chr`: The chromosome where the CGI is located (same as the promoter in the overlap context).

- `start`: The start position of the overlapping CGI.

- `end`: The end position of the overlapping CGI.

- `length`: The length of the CGI in base pairs.

- `CpGcount`: The number of CpG dinucleotides within the CGI.

- `GCcount`: The number of G and C nucleotides within the CGI.

- `pctGC`: The percentage of G and C nucleotides within the CGI.

- `obsExp`: The observed-to-expected ratio of CpG dinucleotides in the CGI.

Each row corresponds to an overlap between a promoter and a CGI. For example:

- The first row shows that a promoter at TSS 755,445 on the negative strand overlaps with a CGI on chromosome NC_036780.1 spanning positions 755,397 to 756,689. This CGI has a length of 1,293 bp, contains 123 CpG dinucleotides, and has a GC content of 63.19% with an observed-to-expected CpG ratio of 0.954.

- The overlap is detailed for both the promoter and the CGI, including their respective properties.

```{r}
#write.table(promoter_cgi_overlap, file = "promoter_cgi_overlap.txt", sep = "\t", row.names = FALSE)
promoter_cgi_overlap <- read.table("/home/sara/methylation/MethEvolSIM/application_examples/abc_inferences/genomic_dist/promoter_cgi_overlap.txt")
```

### Check TSS overlap density

```{r}
plot(
  promoter_cgi_overlap$length, 
  promoter_cgi_overlap$pctGC, 
  xlab = "CGI Length (bp)", 
  ylab = "GC Content (%)", 
  main = "Relationship Between CGI Length and GC Content",
  pch = 16,  # Solid circle points
  col = "blue"  # Point color
)

```


```{r}

```


